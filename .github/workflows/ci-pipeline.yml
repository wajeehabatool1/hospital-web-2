name: CI Pipeline

on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/**'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [14.x, 16.x, 18.x]
        app: [frontend, backend]
    steps:
    # ... (previous steps remain unchanged)

    - name: Run ${{ matrix.app }} unit tests
      run: |
        cd ${{ matrix.app }}
        npm test -- --json --outputFile=test-results.json

    - name: Upload test results
      uses: actions/upload-artifact@v3  # Updated from v2 to v3
      with:
        name: test-results-${{ matrix.app }}-${{ matrix.node-version }}
        path: ${{ matrix.app }}/test-results.json
    
    - name: Run ${{ matrix.app }} linter
      run: |
        docker run hospital-${{ matrix.app }}:${{ github.sha }} npm run lint
    
    - name: Run SAST for ${{ matrix.app }}
      uses: github/codeql-action/analyze@v1
    
    - name: Login to DockerHub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Push ${{ matrix.app }} image to DockerHub
      run: |
        docker tag hospital-${{ matrix.app }}:${{ github.sha }} ${{ secrets.DOCKERHUB_USERNAME }}/hospital-${{ matrix.app }}:${{ github.sha }}
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/hospital-${{ matrix.app }}:${{ github.sha }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    - name: Deploy to staging
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        echo "Deploying to staging environment"
        # Add your deployment script here
    
    